#!/bin/bash

set -e

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install heroku-buildpack-ssh-key"

BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/vendor"
ENV_DIR=${3:-}
BUILDPACK_SSH_KEY="$(cat $ENV_DIR/BUILDPACK_SSH_KEY)"
BUILDPACK_SSH_KEY_PUB="$(cat $ENV_DIR/BUILDPACK_SSH_KEY_PUB)"

if [[ -z $BUILDPACK_SSH_KEY ]]; then
    echo "Did you forget to set BUILDPACK_SSH_KEY?" | indent
    exit 1
fi

mkdir -p $BUILD_DIR/.ssh
chmod 700 $BUILD_DIR/.ssh

# ignore/hide ssh warnings
ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
echo "-----> Generated keys"
echo "Host *" >> $BUILD_DIR/.ssh/config
echo "   StrictHostKeyChecking no" >> $BUILD_DIR/.ssh/config
echo "   UserKnownHostsFile /dev/null" >> $BUILD_DIR/.ssh/config
echo "   LogLevel ERROR" >> $BUILD_DIR/.ssh/config
echo "-----> Added ssh configs"

# install the ssh key
ssh-keyscan -H ftp.campusesp-test.com >> $BUILD_DIR/.ssh/known_hosts 2> /dev/null
# chmod 600 $BUILD_DIR/.ssh/know_hosts
# cat "$ENV_DIR/BUILDPACK_SSH_KEY" > $BUILD_DIR/.ssh/id_rsa
# echo >> $BUILD_DIR/.ssh/id_rsa
# chmod 600 $BUILD_DIR/.ssh/id_rsa
# cat "$ENV_DIR/BUILDPACK_SSH_KEY_PUB" > $BUILD_DIR/.ssh/id_rsa.pub
# echo >> $BUILD_DIR/.ssh/id_rsa.pub
# chmod 600 $BUILD_DIR/.ssh/id_rsa.pub
echo "-----> Installed SSH key from BUILDPACK_SSH_KEY"
echo "-----> Installed SSH key from BUILDPACK_SSH_KEY_PUB"
